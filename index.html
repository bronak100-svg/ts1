<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ד"ר שלמה ברונק - ניהול משימות</title>
    <style>
        body { margin: 0; height: 100vh; background: #f0f2f5; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        #header { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%); 
            background: white; padding: 20px; border-radius: 15px; 
            box-shadow: 0 4px 15px rgba(0,0,0,0.1); 
            display: flex; flex-direction: column; align-items: center; gap: 10px; z-index: 1000; 
        }
        /* העיגול הכחול והתמונה הוסרו מכאן */
        h1 { margin: 0; color: #2c3e50; font-size: 1.4rem; }
        .sticky-note { 
            position: absolute; width: 220px; padding: 15px; 
            background: #fff9c4; border-radius: 10px; 
            box-shadow: 0 4px 8px rgba(0,0,0,0.1); cursor: grab; user-select: none;
        }
        .timer { font-weight: bold; color: #d9534f; direction: ltr; text-align: left; font-size: 1.1em; }
        .expired { background-color: #ff4d4d !important; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }
        .delete-btn { display: block; margin-top: 10px; color: #888; cursor: pointer; font-size: 0.8em; font-weight: bold; }
        button { background: #3498db; color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer; }
    </style>
</head>
<body>

<div id="header">
    <h1>לוח המשימות של ד"ר ברונק</h1>
    <div style="display:flex; gap:10px;">
        <input type="text" id="taskInput" placeholder="מה המשימה?">
        <input type="datetime-local" id="dateInput">
        <button id="addBtn">שמור בענן</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDHXSlIdXaLbpjkF5vNLPirmjDJfIgJf6M",
        authDomain: "todo-2ae6b.firebaseapp.com",
        projectId: "todo-2ae6b",
        storageBucket: "todo-2ae6b.firebasestorage.app",
        messagingSenderId: "576825825783",
        appId: "1:576825825783:web:a98f9df03f910daa4cb6f2"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const tasksCol = collection(db, 'tasks');

    // הוספת משימה חדשה
    document.getElementById('addBtn').onclick = async () => {
        const text = document.getElementById('taskInput').value;
        const date = document.getElementById('dateInput').value;
        if (!text || !date) return alert("מלא את כל השדות");

        await addDoc(tasksCol, {
            text,
            deadline: new Date(date).getTime(),
            top: 250,
            left: 100
        });
        document.getElementById('taskInput').value = "";
    };

    // האזנה לשינויים
    onSnapshot(tasksCol, (snapshot) => {
        document.querySelectorAll('.sticky-note').forEach(n => n.remove());
        snapshot.forEach(docSnap => createNoteUI(docSnap.id, docSnap.data(), db));
    });

    function createNoteUI(id, data, db) {
        const note = document.createElement('div');
        note.className = 'sticky-note';
        note.style.top = data.top + 'px';
        note.style.left = data.left + 'px';
        note.innerHTML = `
            <div style="font-weight:bold">${data.text}</div>
            <div class="timer" id="t-${id}">מחשב זמן...</div>
            <span class="delete-btn" onclick="window.removeTask('${id}')">✖ מחק</span>
        `;

        const interval = setInterval(() => {
            const el = document.getElementById(`t-${id}`);
            if (!el) { clearInterval(interval); return; }

            const dist = data.deadline - Date.now();
            if (isNaN(dist)) { 
                el.innerText = "תאריך לא תקין"; 
                return; 
            }

            if (dist < 0) {
                el.innerText = "הזמן עבר!";
                note.classList.add('expired');
            } else {
                const h = Math.floor(dist / 3600000);
                const m = Math.floor((dist % 3600000) / 60000);
                const s = Math.floor((dist % 60000) / 1000);
                el.innerText = `${h}h ${m}m ${s}s`;
            }
        }, 1000);

        setupDraggable(note, id, db);
        document.body.appendChild(note);
    }

    function setupDraggable(note, id, db) {
        let isDragging = false;
        note.onmousedown = (e) => {
            if (e.target.classList.contains('delete-btn')) return;
            isDragging = true;
            let shiftX = e.clientX - note.getBoundingClientRect().left;
            let shiftY = e.clientY - note.getBoundingClientRect().top;
            document.onmousemove = (e) => {
                if (!isDragging) return;
                note.style.left = (e.clientX - shiftX) + 'px';
                note.style.top = (e.clientY - shiftY) + 'px';
            };
            document.onmouseup = async () => {
                if (isDragging) {
                    isDragging = false;
                    document.onmousemove = null;
                    await updateDoc(doc(db, 'tasks', id), {
                        top: parseInt(note.style.top),
                        left: parseInt(note.style.left)
                    });
                }
            };
        };
    }

    window.removeTask = async (id) => {
        await deleteDoc(doc(db, 'tasks', id));
    };
</script>
</body>
</html>